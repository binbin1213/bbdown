name: Build Latest

on: [push,workflow_dispatch]

env:
  DOTNET_SDK_VERSION: "9.0.306"
  ACTIONS_ALLOW_USE_UNSECURE_NODE_VERSION: true
  DOTNET_CLI_TELEMETRY_OPTOUT: 1
  DOTNET_NOLOGO: true

jobs:
  set-date:
    runs-on: ubuntu-latest
    outputs:
      date: ${{ steps.get_date.outputs.date }}
    steps:
      - name: Get Date in UTC+8
        id: get_date
        run: echo "date=$(date -u -d '8 hours' +'%Y%m%d')" >> "$GITHUB_OUTPUT"

  build-cli-win:
    name: Build CLI for Windows
    runs-on: windows-latest
    needs: set-date
    steps:
      - uses: actions/checkout@v1
      - name: Set up dotnet
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ env.DOTNET_SDK_VERSION }}
      - name: Install zip
        run: choco install zip --no-progress --yes
      - name: Publish
        run: |
          dotnet publish BBDown -r win-x64 -c Release -o artifact
          dotnet publish BBDown -r win-arm64 -c Release -o artifact-arm64
      - name: Package
        run: |
          cd artifact
          zip ../BBDown_${{ needs.set-date.outputs.date }}_win-x64.zip BBDown.exe
          cd ../artifact-arm64
          zip ../BBDown_${{ needs.set-date.outputs.date }}_win-arm64.zip BBDown.exe
      - name: Upload Artifact (win-x64)
        uses: actions/upload-artifact@v4
        with:
          name: BBDown_win-x64
          path: BBDown_${{ needs.set-date.outputs.date }}_win-x64.zip
      - name: Upload Artifact (win-arm64)
        uses: actions/upload-artifact@v4
        with:
          name: BBDown_win-arm64
          path: BBDown_${{ needs.set-date.outputs.date }}_win-arm64.zip

  build-gui-win:
    name: Build GUI for Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
          cache: true
          cache-dependency-path: '**/*.csproj'
      - name: Restore dependencies
        run: dotnet restore BBDown.GUI/BBDown.GUI.csproj
      - name: Publish GUI
        run: dotnet publish BBDown.GUI/BBDown.GUI.csproj -c Release -r win-x64 /p:SelfContained=true /p:PublishTrimmed=false /p:PublishSingleFile=true /p:DebugType=None
      - name: Publish CLI and Bundle
        run: |
          dotnet publish BBDown/BBDown.csproj -c Release -r win-x64 /p:SelfContained=true /p:PublishSingleFile=true /p:DebugType=None -o BBDown-cli
          copy BBDown-cli\BBDown.exe BBDown.GUI\bin\Release\net9.0\win-x64\publish\BBDown.exe
      - name: Download Tools
        run: |
          Invoke-WebRequest -Uri "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip" -OutFile "ffmpeg.zip"
          Expand-Archive "ffmpeg.zip" -DestinationPath "."
          copy "ffmpeg-master-latest-win64-gpl/bin/ffmpeg.exe" "BBDown.GUI/bin/Release/net9.0/win-x64/publish/ffmpeg.exe"
          
          Invoke-WebRequest -Uri "https://github.com/aria2/aria2/releases/download/release-1.37.0/aria2-1.37.0-win-64bit-build1.zip" -OutFile "aria2.zip"
          Expand-Archive "aria2.zip" -DestinationPath "."
          copy "aria2-1.37.0-win-64bit-build1/aria2c.exe" "BBDown.GUI/bin/Release/net9.0/win-x64/publish/aria2c.exe"
      - name: Package
        run: |
          cd BBDown.GUI/bin/Release/net9.0/win-x64/publish
          powershell Compress-Archive -Path * -DestinationPath ../BBDown.GUI-win-x64.zip
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: BBDown.GUI-win-x64
          path: BBDown.GUI/bin/Release/net9.0/win-x64/BBDown.GUI-win-x64.zip
          retention-days: 3

  build-cli-mac:
    name: Build CLI for macOS
    runs-on: macos-latest
    needs: set-date
    steps:
      - uses: actions/checkout@v1
      - name: Set up dotnet
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ env.DOTNET_SDK_VERSION }}
      - name: Publish
        run: |
          dotnet publish BBDown -r osx-x64 -c Release -o artifact
          dotnet publish BBDown -r osx-arm64 -c Release -o artifact-arm64
      - name: Package
        run: |
          cd artifact
          zip ../BBDown_${{ needs.set-date.outputs.date }}_osx-x64.zip BBDown
          cd ../artifact-arm64
          zip ../BBDown_${{ needs.set-date.outputs.date }}_osx-arm64.zip BBDown
      - name: Upload Artifact (osx-x64)
        uses: actions/upload-artifact@v4
        with:
          name: BBDown_osx-x64
          path: BBDown_${{ needs.set-date.outputs.date }}_osx-x64.zip
      - name: Upload Artifact (osx-arm64)
        uses: actions/upload-artifact@v4
        with:
          name: BBDown_osx-arm64
          path: BBDown_${{ needs.set-date.outputs.date }}_osx-arm64.zip

  build-gui-mac:
    name: Build GUI for macOS
    runs-on: macos-15
    strategy:
      matrix:
        rid: [ osx-arm64, osx-x64 ]
    steps:
      - uses: actions/checkout@v4
      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
          cache: true
          cache-dependency-path: '**/*.csproj'
      - name: Restore (with RID)
        run: dotnet restore BBDown.GUI/BBDown.GUI.csproj -r ${{ matrix.rid }}
      - name: Create .app bundle
        run: |
          dotnet msbuild BBDown.GUI/BBDown.GUI.csproj -t:BundleApp \
            -p:RuntimeIdentifier=${{ matrix.rid }} \
            -p:UseAppHost=true \
            -p:SelfContained=true \
            -property:Configuration=Release \
            -p:DebugType=None \
            -p:UseSharedCompilation=false
      - name: Download Tools
        run: |
          # Define URLs
          FFMPEG_URL="https://evermeet.cx/ffmpeg/ffmpeg.7z"
          ARIA2_URL="https://github.com/aria2/aria2/releases/download/release-1.37.0/aria2-1.37.0-osx-darwin.tar.bz2"
          
          APP_DIR="BBDown.GUI/bin/Release/net9.0/${{ matrix.rid }}/publish/BBDown.GUI.app/Contents/MacOS"
          mkdir -p "$APP_DIR"

          # Download and install FFmpeg
          curl -L -o ffmpeg.7z "$FFMPEG_URL"
          7z x ffmpeg.7z
          chmod +x ffmpeg
          cp ffmpeg "$APP_DIR/"
          
          # Download and install Aria2c
          curl -L -o aria2.tar.bz2 "$ARIA2_URL"
          tar xjf aria2.tar.bz2
          chmod +x aria2-1.37.0-osx-darwin/aria2c
          cp aria2-1.37.0-osx-darwin/aria2c "$APP_DIR/"
          
      - name: Publish CLI for same RID
        run: |
          dotnet publish BBDown/BBDown.csproj -c Release -r ${{ matrix.rid }} /p:SelfContained=true /p:PublishSingleFile=true /p:DebugType=None -o BBDown-cli
          APP_DIR="BBDown.GUI/bin/Release/net9.0/${{ matrix.rid }}/publish/BBDown.GUI.app/Contents/MacOS" \
            && cp BBDown-cli/BBDown "$APP_DIR/BBDown"
      - name: Create DMG
        run: |
          APP_PATH="BBDown.GUI/bin/Release/net9.0/${{ matrix.rid }}/publish/BBDown.GUI.app" \
            && DMG_NAME="BBDown.GUI-${{ matrix.rid }}.dmg" \
            && hdiutil create -volname "BBDown" -srcfolder "$APP_PATH" -ov -format UDZO "$DMG_NAME"
      - name: Upload DMG Artifact
        uses: actions/upload-artifact@v4
        with:
          name: BBDown.GUI-${{ matrix.rid }}
          path: BBDown.GUI-${{ matrix.rid }}.dmg
          retention-days: 3

  build-gui-mac-local:
    name: Build GUI for macOS (Local)
    if: ${{ github.repository_owner == 'your-username' }} # Replace with your GitHub username
    runs-on: macos-latest
    strategy:
      matrix:
        rid: [ osx-arm64, osx-x64 ]
    steps:
      - uses: actions/checkout@v4
      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
          cache: true
          cache-dependency-path: '**/*.csproj'
      - name: Restore (with RID)
        run: dotnet restore BBDown.GUI/BBDown.GUI.csproj -r ${{ matrix.rid }}
      - name: Create .app bundle
        run: |
          dotnet msbuild BBDown.GUI/BBDown.GUI.csproj -t:BundleApp \
            -p:RuntimeIdentifier=${{ matrix.rid }} \
            -p:UseAppHost=true \
            -p:SelfContained=true \
            -property:Configuration=Release \
            -p:DebugType=None \
            -p:UseSharedCompilation=false
      - name: Download Tools
        run: |
          # Define URLs
          FFMPEG_URL="https://evermeet.cx/ffmpeg/ffmpeg-7.0.7z"
          ARIA2_URL="https://github.com/aria2/aria2/releases/download/release-1.37.0/aria2-1.37.0-osx-darwin.tar.bz2"
          
          APP_DIR="BBDown.GUI/bin/Release/net9.0/${{ matrix.rid }}/publish/BBDown.GUI.app/Contents/MacOS"
          mkdir -p "$APP_DIR"

          # Download and install FFmpeg
          curl -L -o ffmpeg.7z "$FFMPEG_URL"
          7z x ffmpeg.7z
          chmod +x ffmpeg
          cp ffmpeg "$APP_DIR/"
          
          # Download and install Aria2c
          curl -L -o aria2.tar.bz2 "$ARIA2_URL"
          tar xjf aria2.tar.bz2
          chmod +x aria2-1.37.0-osx-darwin/aria2c
          cp aria2-1.37.0-osx-darwin/aria2c "$APP_DIR/"
          
      - name: Publish CLI for same RID
        run: |
          dotnet publish BBDown/BBDown.csproj -c Release -r ${{ matrix.rid }} /p:SelfContained=true /p:PublishSingleFile=true /p:DebugType=None -o BBDown-cli
          APP_DIR="BBDown.GUI/bin/Release/net9.0/${{ matrix.rid }}/publish/BBDown.GUI.app/Contents/MacOS" \
            && cp BBDown-cli/BBDown "$APP_DIR/BBDown"
      - name: Create DMG
        run: |
          APP_PATH="BBDown.GUI/bin/Release/net9.0/${{ matrix.rid }}/publish/BBDown.GUI.app" \
            && DMG_NAME="BBDown.GUI-${{ matrix.rid }}.dmg" \
            && hdiutil create -volname "BBDown" -srcfolder "$APP_PATH" -ov -format UDZO "$DMG_NAME"
      - name: Upload DMG Artifact
        uses: actions/upload-artifact@v4
        with:
          name: BBDown.GUI-${{ matrix.rid }}
          path: BBDown.GUI-${{ matrix.rid }}.dmg
          retention-days: 3